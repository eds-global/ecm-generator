
import glob as gb
import os
import warnings
import pandas as pd
import re
import streamlit as st
import xlwings as xw # Xlwings is a Python library that makes it easy to call Python from Excel
# used to filter out warning messages generated by modules or functions called in code.
warnings.filterwarnings("ignore")

# function get LSC report based on specific criteria
def get_LSC_report(name, path):
    try:
        # Open the file named 'name' and read its contents
        with open(name) as f:
            # Read all lines from the file and store them in a list named flist
            flist = f.readlines()
            
            # Initialize an empty list to store line numbers where 'LS-C' occurs
            lsc_count = [] 
            for num, line in enumerate(flist, 0):
                # start the line where LS-C occur.
                if 'LS-C' in line:
                    lsc_count.append(num)
                # till LS-D encounter.
                if 'LS-D' in line:
                    numend = num
            # start from 1 line of LS-C report.
            numstart = lsc_count[0] 
            # lsc_rpt is now from LS-C to LS-D lines
            lsc_rpt = flist[numstart:numend]
    
            # create empty list to store the string into list format.
            lsc_str = []
            space = []
            # move in each line of lsc_rpt based on condition and store in lsc_str list
            for line in lsc_rpt:
                line = re.sub(r'(\d)\.(\d+)\.', r'\1. \2.', line)
                if ('.' in line and 'WALL CONDUCTION' in line or 'ROOF CONDUCTION' in line or
                    'WINDOW GLASS+FRM COND' in line or 'WINDOW GLASS SOLAR' in line or 'DOOR CONDUCTION' in line or
                    'INTERNAL SURFACE COND' in line or 'UNDERGROUND SURF COND' in line or 'OCCUPANTS TO SPACE' in line
                    or 'LIGHT     TO SPACE' in line or 'EQUIPMENT TO SPACE' in line or 'PROCESS   TO SPACE'
                    in line or 'INFILTRATION' in line or 'TOTAL' in line and '/' not in line):
                    lsc_str.append(line)
            
            # result list to store filtered columns. after 7th column from last remaining values in 1 column. 
            result = []  
            for line in lsc_str:
                lsc_list = []
                # Split the line by whitespace and store the result in splitter
                splitter = line.split()
                # Join the first part of the splitter except the last 7 elements and store it as space_name
                space_name = " ".join(splitter[:-6])
                # Add space_name as the first element of lvd_list
                lsc_list=splitter[-6:]
                lsc_list.insert(0,space_name)
                # Append lvd_list to result
                result.append(lsc_list)
            
            # store lsc report in a dataframe
            lsc_df = pd.DataFrame(result)
            # drop 2st, 4th, 6th and 7th column
            lsc_df.drop(lsc_df.columns[[1, 3, 5, 6]], axis=1, inplace=True)
            # converting numbers to float.
            lsc_df.iloc[:, -2:] = lsc_df.iloc[:, -2:].apply(pd.to_numeric, errors='coerce')
    
            # Round values to two decimal places
            lsc_df.iloc[:, -2:] = lsc_df.iloc[:, -2:].applymap(lambda x: round(x, 2))
    
            # Convert to float
            lsc_df.iloc[:, -2:] = lsc_df.iloc[:, -2:].astype(float)
            # Add the values from the last two columns and store the result in the third column
            lsc_df['3rd'] = lsc_df.iloc[:, -2] + lsc_df.iloc[:, -1]
            lsc_df.drop(lsc_df.columns[[1, 2]], axis=1, inplace=True)
            lsc_df.columns = range(lsc_df.shape[1])
            # transpose the dataframe to get 1st column as header of dataframe
            lsc_df = lsc_df.T
            lsc_df.columns = lsc_df.iloc[0]
            # drop 1st row
            lsc_df = lsc_df.drop(0)
            # lsc_dfs = lsc_df.loc[:, : 'TOTAL']
            lsc_df = lsc_df.iloc[:, :13]
            lsc_df.rename(columns={'TOTAL': 'TOTAL-LOAD(KW)'}, inplace=True)
    
        return lsc_df
    except Exception as e:
        print(f"An error occurred: {e}")
        columns = ['RUNNAME', 'HEATING_CAPACITY(MBTU/HR)', 'COOLING_CAPACITY(MBTU/HR)', 'LOOP_FLOW(GAL/MIN)',
                   'TOTAL_HEAD(FT)', 'SUPPLY_UA PRODUCT(BTU/HR-F)', 'SUPPLY_LOSS_DT(F)',
                   'RETURN_UA PRODUCT(BTU/HR-F)', 'RETURN_LOSS_DT(F)', 'LOOP_VOLUME(GAL)', 'FLUID_HEAT(CAPACITY)(BTU/LB-F)']
        return pd.DataFrame()

# import glob as gb
# import os
# import warnings
# import pandas as pd
# import xlwings as xw 
# import re

# # Filter out warning messages generated by modules or functions called in code.
# warnings.filterwarnings("ignore")

# # Function to get LSC report based on specific criteria
# def get_LSC_report(name, path):
#     print ("callinglsc")
#     try:
        
#         # Open the file named 'name' and read its contents
#         with open(name) as f:
#             # Read all lines from the file and store them in a list named flist
#             flist = f.readlines()

#             # Initialize an empty list to store line numbers where 'LS-C' occurs
#             lsc_count = []
#             for num, line in enumerate(flist, 0):
#                 # start the line where LS-C occur.
#                 if 'LS-C' in line:
#                     lsc_count.append(num)
#                 # till LS-D encounter.
#                 if 'LS-D' in line:
#                     numend = num
#             # start from 1 line of LS-C report.
#             numstart = lsc_count[0]
#             # lsc_rpt is now from LS-C to LS-D lines
#             lsc_rpt = flist[numstart:numend]

#             # create empty list to store the string into list format.
#             lsc_str = []
#             lsc_str1 = []
#             # move in each line of lsc_rpt based on condition and store in lsc_str list
#             for line in lsc_rpt:
#                 line = re.sub(r'(\d)\.(\d+)\.', r'\1. \2.', line)
#                 if ('.' in line and 'WALL CONDUCTION' in line or 'ROOF CONDUCTION' in line or
#                         'WINDOW GLASS+FRM COND' in line or 'WINDOW GLASS SOLAR' in line or 'DOOR CONDUCTION' in line or
#                         'INTERNAL SURFACE COND' in line or 'UNDERGROUND SURF COND' in line or 'OCCUPANTS TO SPACE' in line
#                         or 'LIGHT     TO SPACE' in line or 'EQUIPMENT TO SPACE' in line or 'PROCESS   TO SPACE'
#                         in line or 'INFILTRATION' in line or 'TOTAL' in line and '/' not in line):
#                     lsc_str.append(line)
#                 elif 'TOTAL LOAD' in line and '/' in line and 'AREA' not in line:
#                     lsc_str1.append(line)

#             # result list to store filtered columns. after 7th column from last remaining values in 1 column.
#             result = []
#             for line in lsc_str:
#                 lsc_list = []
#                 # Split the line by whitespace and store the result in splitter
#                 splitter = line.split()
#                 # Join the first part of the splitter except the last 7 elements and store it as space_name
#                 space_name = " ".join(splitter[:-6])
#                 # Add space_name as the first element of lvd_list
#                 lsc_list = splitter[-6:]
#                 lsc_list.insert(0, space_name)
#                 # Append lvd_list to result
#                 result.append(lsc_list)

#             result1 = []  # Stores TOTAL-LOAD
#             for line in lsc_str1:
#                 splitter1 = line.split()
#                 space_name1 = " ".join(splitter1[:-8])
#                 lsc_list1 = splitter1[-8:]
#                 lsc_list1.insert(0, space_name1)
#                 result1.append(lsc_list1)

#             # store lsc report in a dataframe
#             lsc_df = pd.DataFrame(result)
#             lsc_df1 = pd.DataFrame(result1)
#             # drop 2st, 4th, 6th and 7th column
#             lsc_df.drop(lsc_df.columns[[1, 3, 5, 6]], axis=1, inplace=True)
#             lsc_df1.drop(lsc_df1.columns[[2, 4, 5, 6, 7, 8]], axis=1, inplace=True)
#             # converting numbers to float.
#             lsc_df.iloc[:, -2:] = lsc_df.iloc[:, -2:].astype(float)
#             lsc_df1.iloc[:, -2:] = lsc_df1.iloc[:, -2:].astype(float)
#             # Add the values from the last two columns and store the result in the third column
#             lsc_df['3rd'] = lsc_df.iloc[:, -2] + lsc_df.iloc[:, -1]
#             lsc_df1['3rd1'] = 0
#             lsc_df.drop(lsc_df.columns[[1, 2]], axis=1, inplace=True)
#             lsc_df1.drop(lsc_df1.columns[[1, 2]], axis=1, inplace=True)
#             lsc_df.columns = range(lsc_df.shape[1])
#             lsc_df1.columns = range(lsc_df1.shape[1])
#             # transpose the dataframe to get 1st column as header of dataframe
#             lsc_df = lsc_df.T
#             lsc_df1 = lsc_df1.T
#             lsc_df.columns = lsc_df.iloc[0]
#             lsc_df1.columns = lsc_df1.iloc[0]
#             # drop 1st row
#             lsc_df = lsc_df.drop(0)
#             lsc_df1 = lsc_df1.drop(0)
#             lsc_df.rename(columns={'TOTAL': 'TOTAL-LSC'}, inplace=True)
#             lsc_df['TOTAL-LOAD'] = lsc_df1['TOTAL LOAD'].to_list()

#             # Adding "_KW" suffix to column names
#             new_columns = [col + '(KW)' for col in lsc_df.columns]
#             new_df = lsc_df.copy()
#             new_df.columns = new_columns
#             new_df.drop(['TOTAL-LOAD(KW)'], axis=1, inplace=True)
#             new_df.rename(columns={'TOTAL-LSC(KW)': 'TOTAL-LOAD(KW)'}, inplace=True)
            
#         return new_df
#     except Exception as e:
#         columns = ['RUNNAME', 'HEATING_CAPACITY(MBTU/HR)', 'COOLING_CAPACITY(MBTU/HR)', 'LOOP_FLOW(GAL/MIN)',
#                    'TOTAL_HEAD(FT)', 'SUPPLY_UA PRODUCT(BTU/HR-F)', 'SUPPLY_LOSS_DT(F)',
#                    'RETURN_UA PRODUCT(BTU/HR-F)', 'RETURN_LOSS_DT(F)', 'LOOP_VOLUME(GAL)', 'FLUID_HEAT(CAPACITY)(BTU/LB-F)']
#         print (f"Error: {e}")
#         return pd.DataFrame(columns=columns)